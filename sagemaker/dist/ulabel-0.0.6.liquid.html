
<link rel="stylesheet" href="https://ulabel-versions.s3.amazonaws.com/ulabel-0.0.6.css">


<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
    
<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.1.0/uuidv4.min.js"></script>

<script src="https://ulabel-versions.s3.amazonaws.com/ulabel-0.0.6.js"></script>


<style type="text/css">
/* ================================== ULABEL.css ================================== */
/* Don't display what SageMaker wants to display */
crowd-form {
    display: none;
}

/* Give the entire window to ULabel */
html, body, #ulabel-cont {
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100vh;
}
</style>

<script>
/* ================================== from CREATE_TEMPLATE.py ================================== */
// The first item is with templating, the second is a backup if tempate isn't run
// If no second item is provided, the first must not fail
var JOB_CONFIG = {
    "strings": {
        "image_url": ["{{task.input.source-ref | grant_read_access}}", "/demo_image.jpg"],
        "image_id": ["{{task.input.id}}", "__no_image_id_provided__"],
        "container": ["ulabel-cont"],
        "annotator": ["__placeholder__"],
        "batch_id": ["{{task.input.batch_id}}", "__no_batch_id_provided__"],
        "task_id": ["{{task.input.task_id}}", "__no_task_id_provided__"],
        "dst_field": ["whole-field"]
    },
    "stringified_objs": {
        "taxonomy": [`null`], 
        "class_defs": [`null`],
        "allowed_modes": [``, `["polygon", "bbox", "contour"]`],
        "resume_from": [`{{task.input.resume_from}}`, `null`]
    }
}
console.log(JOB_CONFIG);
/* ================================== USE_ULABEL.js ================================== */
/* global JOB_CONFIG */

function not_templated(key) {
    return (key.substring(0,2) == "{"+"{");
}


function process_configuration(raw_cfg) {
    console.log("RAW CONFIGURATION");
    console.log(JSON.stringify(raw_cfg, null, 2));
    let cfg = {
        "strings": {},
        "stringified_objs": {}
    };
    for (const [key, val] of Object.entries(raw_cfg["strings"])) {
        if (not_templated(val[0])) {
            console.log("Template value for " + key + " was not provided. Using default value.");
            cfg["strings"][key] = val[1];
        }
        else {
            cfg["strings"][key] = val[0];
        }
    }
    for (const [key, val] of Object.entries(raw_cfg["stringified_objs"])) {
        if (not_templated(val[0])) {
            console.log("Template value for " + key + " was not provided. Using default value.");
            cfg["stringified_objs"][key] = JSON.parse(val[1]);
        }
        else {
            try {
                cfg["stringified_objs"][key] = JSON.parse(val[0]);
            }
            catch(err) {
                console.log("Template value for " + key + " was not a valid json. Using default value.");
                cfg["stringified_objs"][key] = JSON.parse(val[1]);
            }            
        }
    }
    console.log("Job Configuration");
    console.log(JSON.stringify(cfg, null, 2));
    return cfg;
}

$(document).ready(function() {
    // If template didn't run, show demo instead
    var cfg = process_configuration(JOB_CONFIG);

    function save_callback(payload) {
        // TODO handles what to do when the platform wants to save
        console.log("Called save on:", payload);
    }
    
    function exit_callback(payload) {
        // TODO handles what to do when the platform wants to exit before finishing
        console.log("Called exit on:", payload);
    }
    
    function done_callback(payload) {
        // TODO handles what to do when the platform is indicating that the user has finished
        $("#" + cfg["strings"]["dst_field"]).val(JSON.stringify(payload));
        $("crowd-button").click();
    }

    var ulabel = new ULabel(
        cfg["strings"]["container"],
        cfg["strings"]["image_url"],
        cfg["strings"]["annotator"],
        cfg["stringified_objs"]["taxonomy"],
        cfg["stringified_objs"]["class_defs"],
        save_callback,
        exit_callback,
        done_callback,
        cfg["stringified_objs"]["allowed_modes"],
        cfg["stringified_objs"]["resume_from"],
        {
            "task_id": cfg["strings"]["task_id"],
            "batch_id": cfg["strings"]["batch_id"],
            "image_id": cfg["strings"]["image_id"]
        }, // task_meta
        {
            "task_id": cfg["strings"]["task_id"],
            "batch_id": cfg["strings"]["batch_id"],
            "image_id": cfg["strings"]["image_id"]
        } // annotation_meta
    );
    ulabel.init(function() {
        console.log("inited!");
    });
});
</script>

<div id="ulabel-cont"></div>

<crowd-form>
    <input id="whole-field" name="whole-field" type="text" />
</crowd-form>
